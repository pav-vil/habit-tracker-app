{% extends "base.html" %}

{% block title %}Payment Admin Dashboard - HabitFlow{% endblock %}

{% block extra_css %}
<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, Oxygen, Ubuntu, sans-serif;
        background: linear-gradient(180deg, #f3e8ff 0%, #f9fafb 50%, #ffffff 100%);
        min-height: 100vh;
    }

    body.dark-mode {
        background: linear-gradient(180deg, #1a1a1f 0%, #111115 50%, #0a0a0c 100%);
    }

    .container {
        max-width: 1400px;
        padding: 40px 20px;
    }

    .admin-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .admin-title {
        font-size: 3rem;
        font-weight: 800;
        color: var(--text-primary);
        margin-bottom: 12px;
    }

    .admin-subtitle {
        font-size: 1.125rem;
        color: var(--text-secondary);
    }

    /* Statistics Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(24px) saturate(180%);
        -webkit-backdrop-filter: blur(24px) saturate(180%);
        border: 1px solid rgba(124, 58, 237, 0.08);
        border-radius: 20px;
        padding: 24px;
        text-align: center;
        transition: all 0.3s ease;
    }

    body.dark-mode .stat-card {
        background: rgba(30, 30, 35, 0.75);
        border: 1px solid rgba(124, 58, 237, 0.2);
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(124, 58, 237, 0.15);
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-pending { color: #f59e0b; }
    .stat-approved { color: #10b981; }
    .stat-rejected { color: #ef4444; }
    .stat-total { color: #7c3aed; }

    /* Filter Tabs */
    .filter-tabs {
        display: flex;
        gap: 12px;
        margin-bottom: 32px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .filter-tab {
        background: rgba(255, 255, 255, 0.6);
        border: 2px solid rgba(124, 58, 237, 0.15);
        padding: 12px 28px;
        border-radius: 16px;
        font-weight: 600;
        color: var(--text-secondary);
        text-decoration: none;
        transition: all 0.3s ease;
    }

    body.dark-mode .filter-tab {
        background: rgba(30, 30, 35, 0.6);
    }

    .filter-tab:hover {
        background: rgba(124, 58, 237, 0.1);
        color: var(--text-primary);
    }

    .filter-tab.active {
        background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%);
        color: white;
        border-color: #7c3aed;
    }

    /* Payment Request Cards */
    .request-card {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(24px) saturate(180%);
        -webkit-backdrop-filter: blur(24px) saturate(180%);
        border: 1px solid rgba(124, 58, 237, 0.08);
        border-radius: 20px;
        padding: 28px;
        margin-bottom: 24px;
    }

    body.dark-mode .request-card {
        background: rgba(30, 30, 35, 0.75);
        border: 1px solid rgba(124, 58, 237, 0.2);
    }

    .request-card.pending {
        border-left: 4px solid #f59e0b;
    }

    .request-card.approved {
        border-left: 4px solid #10b981;
    }

    .request-card.rejected {
        border-left: 4px solid #ef4444;
    }

    .request-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
        gap: 16px;
        flex-wrap: wrap;
    }

    .request-info h3 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .request-meta {
        font-size: 0.9375rem;
        color: var(--text-secondary);
    }

    .status-badge {
        padding: 8px 20px;
        border-radius: 20px;
        font-weight: 700;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-pending { background: rgba(245, 158, 11, 0.2); color: #d97706; }
    .status-approved { background: rgba(16, 185, 129, 0.2); color: #059669; }
    .status-rejected { background: rgba(239, 68, 68, 0.2); color: #dc2626; }

    .request-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
        padding: 20px;
        background: rgba(124, 58, 237, 0.03);
        border-radius: 12px;
    }

    body.dark-mode .request-details {
        background: rgba(124, 58, 237, 0.08);
    }

    .detail-item {
        color: var(--text-secondary);
    }

    .detail-label {
        font-weight: 700;
        color: var(--text-primary);
        display: block;
        margin-bottom: 4px;
        font-size: 0.875rem;
    }

    .detail-value {
        font-size: 1rem;
    }

    .admin-actions {
        display: flex;
        gap: 12px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .btn-approve {
        background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        color: white;
        border: none;
        padding: 12px 32px;
        border-radius: 16px;
        font-weight: 600;
        font-size: 0.9375rem;
        cursor: pointer;
        transition: all 0.3s ease;
        flex: 1;
        min-width: 150px;
    }

    .btn-approve:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
    }

    .btn-reject {
        background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
        color: white;
        border: none;
        padding: 12px 32px;
        border-radius: 16px;
        font-weight: 600;
        font-size: 0.9375rem;
        cursor: pointer;
        transition: all 0.3s ease;
        flex: 1;
        min-width: 150px;
    }

    .btn-reject:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
    }

    .admin-notes-input {
        background: rgba(124, 58, 237, 0.05);
        border: 1px solid rgba(124, 58, 237, 0.15);
        color: var(--text-primary);
        border-radius: 12px;
        padding: 12px 16px;
        font-size: 0.9375rem;
        width: 100%;
        margin-top: 12px;
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Oxygen, Ubuntu, sans-serif;
    }

    body.dark-mode .admin-notes-input {
        background: rgba(124, 58, 237, 0.1);
        border-color: rgba(124, 58, 237, 0.25);
        color: #e5e7eb;
    }

    .empty-state {
        text-align: center;
        padding: 80px 20px;
    }

    .empty-icon {
        font-size: 5rem;
        margin-bottom: 20px;
        opacity: 0.3;
    }

    .empty-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 12px;
    }

    @media (max-width: 768px) {
        .admin-actions {
            flex-direction: column;
        }

        .btn-approve, .btn-reject {
            width: 100%;
        }

        .request-details {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="admin-header">
        <h1 class="admin-title">üîê Payment Admin Dashboard</h1>
        <p class="admin-subtitle">Manage SINPE M√≥vil payment requests and activate subscriptions</p>
    </div>

    <!-- Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value stat-pending">{{ stats.pending }}</div>
            <div class="stat-label">Pending</div>
        </div>
        <div class="stat-card">
            <div class="stat-value stat-approved">{{ stats.approved }}</div>
            <div class="stat-label">Approved</div>
        </div>
        <div class="stat-card">
            <div class="stat-value stat-rejected">{{ stats.rejected }}</div>
            <div class="stat-label">Rejected</div>
        </div>
        <div class="stat-card">
            <div class="stat-value stat-total">{{ stats.total }}</div>
            <div class="stat-label">Total Requests</div>
        </div>
    </div>

    <!-- Filter Tabs -->
    <div class="filter-tabs">
        <a href="{{ url_for('manual_payment.admin_dashboard', status='pending') }}"
           class="filter-tab {% if current_filter == 'pending' %}active{% endif %}">
            Pending
        </a>
        <a href="{{ url_for('manual_payment.admin_dashboard', status='approved') }}"
           class="filter-tab {% if current_filter == 'approved' %}active{% endif %}">
            Approved
        </a>
        <a href="{{ url_for('manual_payment.admin_dashboard', status='rejected') }}"
           class="filter-tab {% if current_filter == 'rejected' %}active{% endif %}">
            Rejected
        </a>
        <a href="{{ url_for('manual_payment.admin_dashboard', status='all') }}"
           class="filter-tab {% if current_filter == 'all' %}active{% endif %}">
            All
        </a>
    </div>

    <!-- Payment Requests -->
    {% if payment_requests %}
        {% for req in payment_requests %}
        <div class="request-card {{ req.status }}">
            <div class="request-header">
                <div class="request-info">
                    <h3>{{ req.user.email }}</h3>
                    <div class="request-meta">
                        Request ID: #{{ req.id }} ‚Ä¢
                        Submitted {{ req.created_at.strftime('%b %d, %Y at %I:%M %p') }}
                    </div>
                </div>
                <span class="status-badge status-{{ req.status }}">{{ req.status }}</span>
            </div>

            <div class="request-details">
                <div class="detail-item">
                    <span class="detail-label">Subscription Plan</span>
                    <span class="detail-value">{{ req.subscription_tier|title }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Amount</span>
                    <span class="detail-value">‚Ç°{{ "{:,.0f}".format(req.amount) }} {{ req.currency }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Payment Method</span>
                    <span class="detail-value">{{ req.payment_method.replace('_', ' ')|title }}</span>
                </div>
                {% if req.phone_number %}
                <div class="detail-item">
                    <span class="detail-label">Phone Number</span>
                    <span class="detail-value">{{ req.phone_number }}</span>
                </div>
                {% endif %}
                <div class="detail-item">
                    <span class="detail-label">Transaction Reference</span>
                    <span class="detail-value">{{ req.transaction_reference }}</span>
                </div>
                {% if req.payment_proof_notes %}
                <div class="detail-item">
                    <span class="detail-label">User Notes</span>
                    <span class="detail-value">{{ req.payment_proof_notes }}</span>
                </div>
                {% endif %}
            </div>

            {% if req.status == 'pending' %}
            <!-- Approve Form -->
            <form method="POST" action="{{ url_for('manual_payment.approve_request', request_id=req.id) }}">
                <input type="text" name="admin_notes" class="admin-notes-input"
                       placeholder="Optional admin notes for approval...">
                <div class="admin-actions">
                    <button type="submit" class="btn-approve"
                            onclick="return confirm('Approve this payment and activate {{ req.subscription_tier }} subscription for {{ req.user.email }}?');">
                        ‚úì Approve & Activate
                    </button>
                </div>
            </form>

            <!-- Reject Form -->
            <form method="POST" action="{{ url_for('manual_payment.reject_request', request_id=req.id) }}" style="margin-top: 12px;">
                <input type="text" name="admin_notes" class="admin-notes-input"
                       placeholder="Reason for rejection (required)..." required>
                <div class="admin-actions">
                    <button type="submit" class="btn-reject"
                            onclick="return confirm('Reject this payment request?');">
                        ‚úó Reject Request
                    </button>
                </div>
            </form>

            {% elif req.status in ['approved', 'rejected'] %}
            <div class="detail-item" style="margin-top: 16px;">
                <span class="detail-label">Reviewed By</span>
                <span class="detail-value">{{ req.reviewer.email if req.reviewer else 'Unknown' }}</span>
                <span class="detail-value" style="display: block; margin-top: 4px;">
                    {{ req.reviewed_at.strftime('%b %d, %Y at %I:%M %p') if req.reviewed_at else 'N/A' }}
                </span>
            </div>
            {% if req.admin_notes %}
            <div class="detail-item" style="margin-top: 12px;">
                <span class="detail-label">Admin Notes</span>
                <span class="detail-value">{{ req.admin_notes }}</span>
            </div>
            {% endif %}
            {% endif %}
        </div>
        {% endfor %}

    {% else %}
        <div class="empty-state">
            <div class="empty-icon">üì≠</div>
            <div class="empty-title">No {{ current_filter if current_filter != 'all' else '' }} payment requests</div>
        </div>
    {% endif %}
</div>
{% endblock %}
