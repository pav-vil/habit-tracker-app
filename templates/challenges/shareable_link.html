{% extends "base.html" %}

{% block title %}Shareable Link - {{ challenge.name }} - HabitFlow{% endblock %}

{% block extra_css %}
<style>
    h1, h2 { color: var(--text-primary); }
    .page-title {
        font-size: 2rem;
        font-weight: 700;
        background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .link-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 4px 15px var(--shadow-color);
        text-align: center;
    }
    .link-box {
        background: rgba(124, 58, 237, 0.05);
        border: 2px solid #7c3aed;
        border-radius: 12px;
        padding: 20px;
        margin: 25px 0;
        word-break: break-all;
    }
    .link-url {
        font-size: 1.1rem;
        color: #7c3aed;
        font-weight: 600;
        font-family: monospace;
    }
    .btn-copy {
        background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        font-weight: 600;
        border-radius: 10px;
        margin: 10px;
    }
    .btn-copy:hover { opacity: 0.9; }
    .expires-notice {
        color: #6b7280;
        font-size: 0.9rem;
        margin-top: 15px;
    }
    body.dark-mode .expires-notice { color: #9ca3af; }

    /* Instagram button styling */
    #instagram-share-btn {
        background: linear-gradient(135deg, #833ab4 0%, #fd1d1d 50%, #fcb045 100%);
        color: white;
        border: none;
        transition: all 0.3s ease;
    }

    #instagram-share-btn:hover {
        background: linear-gradient(135deg, #6b2f94 0%, #d61818 50%, #e09638 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(131, 58, 180, 0.4);
        color: white;
    }

    #instagram-share-btn.btn-success {
        background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        border: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <h1 class="page-title mb-4">üîó Shareable Invite Link</h1>

            <div class="link-card">
                <div style="font-size: 3rem; margin-bottom: 20px;">üéØ</div>
                <h3 style="margin-bottom: 15px;">{{ challenge.name }}</h3>
                <p style="color: #6b7280; margin-bottom: 25px;">
                    Share this link with anyone to invite them to your challenge!
                </p>

                <div class="link-box">
                    <div class="link-url" id="invite-link">{{ invite_url }}</div>
                </div>

                <button onclick="copyLink()" class="btn-copy" id="copy-btn">
                    üìã Copy Link
                </button>

                <div class="expires-notice">
                    This link expires on {{ invite.expires_at.strftime('%B %d, %Y') }}
                </div>

                <hr style="margin: 30px 0; border-color: var(--border-color);">

                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="shareOnInstagram()" class="btn btn-outline-primary" id="instagram-share-btn">
                        üì∑ Share on Instagram
                    </button>
                    <a href="https://twitter.com/intent/tweet?text=Join%20my%20challenge%20on%20HabitFlow!&url={{ invite_url|urlencode }}"
                       target="_blank"
                       class="btn btn-outline-primary">
                        üê¶ Share on Twitter
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u={{ invite_url|urlencode }}"
                       target="_blank"
                       class="btn btn-outline-primary">
                        üìò Share on Facebook
                    </a>
                    <a href="mailto:?subject=Join%20my%20HabitFlow%20Challenge&body=I%20invite%20you%20to%20join%20my%20challenge%20on%20HabitFlow:%20{{ invite_url|urlencode }}"
                       class="btn btn-outline-primary">
                        üìß Share via Email
                    </a>
                </div>

                <div style="margin-top: 30px;">
                    <a href="{{ url_for('challenges.detail', challenge_id=challenge.id) }}" class="btn btn-outline-secondary">
                        ‚Üê Back to Challenge
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function copyLink() {
    const linkText = document.getElementById('invite-link').textContent;
    const copyBtn = document.getElementById('copy-btn');

    navigator.clipboard.writeText(linkText).then(function() {
        // Success feedback
        copyBtn.textContent = '‚úÖ Copied!';
        copyBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #34d399 100%)';

        // Reset after 2 seconds
        setTimeout(function() {
            copyBtn.textContent = 'üìã Copy Link';
            copyBtn.style.background = 'linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%)';
        }, 2000);
    }).catch(function(err) {
        alert('Failed to copy link. Please copy manually.');
    });
}

async function shareOnInstagram() {
    const linkText = document.getElementById('invite-link').textContent;
    const challengeName = "{{ challenge.name }}";
    const shareText = `Join my "${challengeName}" challenge on HabitFlow! üéØ\n\n${linkText}`;
    const instagramBtn = document.getElementById('instagram-share-btn');

    // Try Web Share API first (works on mobile)
    if (navigator.share) {
        try {
            await navigator.share({
                title: `Join my ${challengeName} challenge!`,
                text: shareText,
                url: linkText
            });

            // Success feedback
            instagramBtn.innerHTML = '‚úÖ Shared!';
            instagramBtn.classList.add('btn-success');
            instagramBtn.classList.remove('btn-outline-primary');

            setTimeout(function() {
                instagramBtn.innerHTML = 'üì∑ Share on Instagram';
                instagramBtn.classList.remove('btn-success');
                instagramBtn.classList.add('btn-outline-primary');
            }, 2000);
        } catch (err) {
            // User cancelled or share failed
            if (err.name !== 'AbortError') {
                console.error('Share failed:', err);
            }
        }
    } else {
        // Fallback: Copy to clipboard with Instagram instructions
        try {
            await navigator.clipboard.writeText(shareText);

            // Show success message
            instagramBtn.innerHTML = '‚úÖ Copied!';
            instagramBtn.classList.add('btn-success');
            instagramBtn.classList.remove('btn-outline-primary');

            // Show instructions
            alert('üì∑ Link copied!\n\nTo share on Instagram:\n1. Open Instagram app\n2. Create a new Story or Post\n3. Paste the link in your caption\n4. Tag @habitflow (if available)');

            setTimeout(function() {
                instagramBtn.innerHTML = 'üì∑ Share on Instagram';
                instagramBtn.classList.remove('btn-success');
                instagramBtn.classList.add('btn-outline-primary');
            }, 2000);
        } catch (err) {
            alert('Failed to copy. Please copy the link manually and share on Instagram!');
        }
    }
}
</script>
{% endblock %}
